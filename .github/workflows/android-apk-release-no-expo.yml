name: Android APK Release (No Expo Platform)

on:
  workflow_dispatch:

jobs:
  build-release-apk:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.2
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: pnpm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install dependencies
        working-directory: packages/mobile
        run: pnpm install --frozen-lockfile --ignore-workspace

      - name: Patch react-native-static-server Android Gradle config
        run: |
          TARGET="$(find packages/mobile/node_modules node_modules -path '*/react-native-static-server/android/build.gradle' 2>/dev/null | head -n 1)"
          if [ -z "$TARGET" ]; then
            echo "react-native-static-server build.gradle not found, skip patch."
            exit 0
          fi
          echo "Overwriting $TARGET with AGP8-compatible config"
          cat > "$TARGET" <<'EOF'
          apply plugin: "com.android.library"

          def safeExtGet(prop, fallback) {
              rootProject.ext.has(prop) ? rootProject.ext.get(prop) : fallback
          }

          android {
              compileSdkVersion safeExtGet("compileSdkVersion", 36)
              defaultConfig {
                  minSdkVersion safeExtGet("minSdkVersion", 24)
                  targetSdkVersion safeExtGet("targetSdkVersion", 36)
              }
              lintOptions {
                  abortOnError false
              }
          }

          repositories {
              mavenLocal()
              google()
              mavenCentral()
          }

          dependencies {
              implementation "com.facebook.react:react-android"
              implementation "org.nanohttpd:nanohttpd:2.3.1"
              implementation "org.nanohttpd:nanohttpd-webserver:2.3.1"
          }
          EOF

      - name: Configure Android keystore
        working-directory: packages/mobile/android
        run: |
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 --decode > app/keystore.jks
          cat > keystore.properties <<EOF
          storeFile=keystore.jks
          storePassword=${ANDROID_KEYSTORE_PASSWORD}
          keyAlias=${ANDROID_KEY_ALIAS}
          keyPassword=${ANDROID_KEY_PASSWORD}
          EOF
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Build Android APK (release)
        working-directory: packages/mobile/android
        run: ./gradlew assembleRelease

      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-release-no-expo
          path: packages/mobile/android/app/build/outputs/apk/release/app-release.apk
          if-no-files-found: error
