name: Desktop Package

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  build-desktop:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest]
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.2
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: pnpm

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Build desktop package (macOS)
        if: matrix.os == 'macos-latest'
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: "false"
        run: pnpm run desktop:pack

      - name: Build desktop package (Windows)
        if: matrix.os == 'windows-latest'
        env:
          CSC_IDENTITY_AUTO_DISCOVERY: "false"
        run: pnpm run desktop:pack

      - name: Upload desktop package
        uses: actions/upload-artifact@v4
        with:
          name: desktop-package-${{ matrix.os }}
          path: packages/desktop/release
          if-no-files-found: error

  build-android:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9.15.2
          run_install: false

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: pnpm

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install dependencies
        working-directory: packages/mobile
        run: pnpm install --frozen-lockfile --ignore-workspace

      - name: Patch react-native-static-server Android Gradle config
        run: |
          TARGET="$(find packages/mobile/node_modules node_modules -path '*/react-native-static-server/android/build.gradle' 2>/dev/null | head -n 1)"
          if [ -z "$TARGET" ]; then
            echo "react-native-static-server build.gradle not found, skip patch."
            exit 0
          fi
          echo "Overwriting $TARGET with AGP8-compatible config"
          cat > "$TARGET" <<'EOF'
          apply plugin: "com.android.library"

          def safeExtGet(prop, fallback) {
              rootProject.ext.has(prop) ? rootProject.ext.get(prop) : fallback
          }

          android {
              compileSdkVersion safeExtGet("compileSdkVersion", 36)
              defaultConfig {
                  minSdkVersion safeExtGet("minSdkVersion", 24)
                  targetSdkVersion safeExtGet("targetSdkVersion", 36)
              }
              lintOptions {
                  abortOnError false
              }
          }

          repositories {
              mavenLocal()
              google()
              mavenCentral()
          }

          dependencies {
              implementation "com.facebook.react:react-android"
              implementation "org.nanohttpd:nanohttpd:2.3.1"
              implementation "org.nanohttpd:nanohttpd-webserver:2.3.1"
          }
          EOF

      - name: Configure Android keystore
        working-directory: packages/mobile/android
        run: |
          echo "${ANDROID_KEYSTORE_BASE64}" | base64 --decode > app/keystore.jks
          cat > keystore.properties <<EOF
          storeFile=keystore.jks
          storePassword=${ANDROID_KEYSTORE_PASSWORD}
          keyAlias=${ANDROID_KEY_ALIAS}
          keyPassword=${ANDROID_KEY_PASSWORD}
          EOF
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          ANDROID_KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          ANDROID_KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}

      - name: Build Android APK (release)
        working-directory: packages/mobile/android
        run: ./gradlew assembleRelease

      - name: Upload release APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk-release-no-expo
          path: packages/mobile/android/app/build/outputs/apk/release/app-release.apk
          if-no-files-found: error

  bundle-cross-assets:
    needs: [build-desktop, build-android]
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Download macOS desktop artifact
        uses: actions/download-artifact@v4
        with:
          name: desktop-package-macos-latest
          path: dist/desktop-mac

      - name: Download Android APK artifact
        uses: actions/download-artifact@v4
        with:
          name: android-apk-release-no-expo
          path: dist/android

      - name: Create cross-download bundles
        run: |
          mkdir -p dist/cross/android-with-desktop dist/cross/desktop-with-android
          cp -v dist/android/app-release.apk dist/cross/android-with-desktop/
          cp -v dist/android/app-release.apk dist/cross/desktop-with-android/

          cp -v dist/desktop-mac/*.dmg dist/cross/android-with-desktop/
          cp -v dist/desktop-mac/*.zip dist/cross/android-with-desktop/ || true
          cp -v dist/desktop-mac/*.dmg dist/cross/desktop-with-android/
          cp -v dist/desktop-mac/*.zip dist/cross/desktop-with-android/ || true

          cd dist/cross
          zip -r android-with-desktop.zip android-with-desktop
          zip -r desktop-with-android.zip desktop-with-android

      - name: Upload cross-download bundles
        uses: actions/upload-artifact@v4
        with:
          name: cross-download-bundles
          path: |
            dist/cross/android-with-desktop.zip
            dist/cross/desktop-with-android.zip
          if-no-files-found: error

  publish-release-assets:
    needs: [bundle-cross-assets]
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download cross-download bundles
        uses: actions/download-artifact@v4
        with:
          name: cross-download-bundles
          path: dist/cross

      - name: Create or update rolling release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: nightly-main
          name: Nightly Main Build
          body: |
            Auto-updated from main branch workflow.
            Includes cross-download bundles:
            - android-with-desktop.zip
            - desktop-with-android.zip
          prerelease: true
          make_latest: false
          files: |
            dist/cross/android-with-desktop.zip
            dist/cross/desktop-with-android.zip
